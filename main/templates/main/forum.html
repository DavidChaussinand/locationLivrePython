{% extends 'base.html' %}

{% block title %}Forum{% endblock %}

{% block content %}
<div class="container mt-5 height">

    {% if user.is_authenticated %}
        <h2>Bienvenue sur le forum, {{ user.username }} !</h2>
        <!-- Affichage des sujets de discussion -->
        <div class="row">
            {% for topic in topics %}
                <div class="col-12 col-md-6 col-lg-4 mb-4">
                    <div class="card shadow-lg">
                        <div class="card-body">
                            <h5 class="card-title">{{ topic.title }}</h5>
                            <p class="card-text">
                                Cr√©√© par <strong>{{ topic.author.username }}</strong> 
                                le {{ topic.created_at|date:"d M Y" }}
                            </p>
                            <p class="card-text">
                                Derni√®re r√©ponse le {{ topic.updated_at|date:"d M Y" }}
                            </p>
                            <a href="{% url 'topic_detail' topic.id %}" class="btn btn-primary">Voir le sujet</a>
                        </div>
                    </div>
                </div>
            {% endfor %}
        </div>
    {% else %}
        <div class="alert alert-warning text-center">
            <p>Pour acc√©der au forum, veuillez <a href="{% url 'login' %}?next={% url 'forum' %}">vous connecter</a> ou <a href="{% url 'signup' %}">cr√©er un compte</a>.</p>
        </div>
    {% endif %}

    <!-- Fen√™tre de chat -->
    <div class="chat-container" id="chatWindow" style="display: none;">
        <div class="chat-header">
            <button id="publicChatBtn" class="chat-btn">Public</button>
            <div class="vertical-line"></div>
            <button id="privateChatBtn" class="chat-btn">Priv√©</button>
        </div>
        <div class="chat-body" id="publicChatBody">
            <!-- Messages du chat public appara√Ætront ici -->
        </div>
  <!-- Fen√™tre de chat priv√© (affich√©e uniquement quand on clique sur "Priv√©") -->
        <div class="chat-body" id="privateChatBody" style="display: none;">
            <div class="row">
                <!-- Colonne gauche : Liste des utilisateurs -->
                <div class="col-4" id="userList">
                    <h4>Utilisateurs</h4>
                    <ul class="list-group">
                        {% for item in user_profiles %}
                        <li class="list-group-item user-item" data-username="{{ item.user.username }}">
                            {{ item.user.username }}
                            <!-- Boule verte si connect√©, grise sinon -->
                            {% if item.is_connect %}
                            <span style="color:rgb(81, 244, 81);">‚óè</span>
                            {% else %}
                            <span style="color:gray;">‚óè</span>
                            {% endif %}
                        </li>
                        {% endfor %}
                    </ul>
                </div>

                <!-- Colonne droite : Bo√Æte de dialogue priv√©e -->
                <div class="col-8">
                    <div id="privateChatMessages">
                        <!-- Les messages du chat priv√© appara√Ætront ici -->
                    </div>
                    <div class="chat-footer" id="privateChatFooter">
                        <textarea id="privateChatMessageInput" placeholder="√âcris ton message ici..." class="form-control"></textarea>
                        <button id="sendPrivateMessageBtn" class="btn btn-primary">Envoyer</button>
                    </div>
                    
                </div>
            </div>
        </div>

        <div class="chat-footer" id="publicChatFooter">
            <textarea id="chatMessageInput" placeholder="√âcris ton message ici..." class="form-control"></textarea>
            <button id="sendMessageBtn" class="btn btn-primary">Envoyer</button>
        </div>
        
    </div>
    
    <!-- Bouton pour ouvrir le chat -->
    <button id="chatToggleBtn" class="chat-toggle-btn">üí¨</button>
    

</div>
{% endblock %}

<!-- Script JavaScript -->
{% block extra_scripts %}
<script>
    // Gestion de l'affichage de la fen√™tre de chat
    document.addEventListener('DOMContentLoaded', function() {
        const chatWindow = document.getElementById('chatWindow');
        const chatToggleBtn = document.getElementById('chatToggleBtn');
        const publicChatBtn = document.getElementById('publicChatBtn');
        const privateChatBtn = document.getElementById('privateChatBtn');
        const publicChatBody = document.getElementById('publicChatBody');
        const privateChatBody = document.getElementById('privateChatBody');
        const privateChatMessages = document.getElementById('privateChatMessages');
        let activePrivateChatUser = null;  // L'utilisateur avec qui on discute en priv√©

        // Toggle de l'affichage du chat
        chatToggleBtn.addEventListener('click', function() {
            if (chatWindow.style.display === 'none') {
                chatWindow.style.display = 'block';
            } else {
                chatWindow.style.display = 'none';
            }
        });

        // Affichage du chat public par d√©faut
        publicChatBtn.addEventListener('click', function() {
            publicChatBody.style.display = 'block';
            privateChatBody.style.display = 'none';
        });

        // Affichage du chat priv√©
        privateChatBtn.addEventListener('click', function() {
            publicChatBody.style.display = 'none';
            privateChatBody.style.display = 'block';
        });

        // S√©lectionnez l'onglet Public par d√©faut au chargement
        publicChatBtn.click();

        // Ajouter un √©couteur d'√©v√©nement pour chaque utilisateur dans la liste (pour chat priv√©)
        document.querySelectorAll('.user-item').forEach(function(userItem) {
            userItem.addEventListener('click', function() {
                const selectedUsername = this.dataset.username;

                // D√©finir l'utilisateur actuellement s√©lectionn√©
                activePrivateChatUser = selectedUsername;

                // Afficher la bo√Æte de dialogue priv√©e pour cet utilisateur
                privateChatMessages.innerHTML = `<h5>Chat avec ${selectedUsername}</h5>`;
                // Ici, vous pouvez ajouter une logique pour charger les anciens messages de la base de donn√©es
            });
        });
    });

    // WebSocket pour le chat public
    const chatSocket = new WebSocket('ws://' + window.location.host + '/ws/chat/');

    // Lorsqu'un nouveau message est re√ßu via WebSocket (pour le chat public)
    chatSocket.onmessage = function(e) {
        const data = JSON.parse(e.data);
        const chatLog = document.querySelector('#publicChatBody');

        // Cr√©er un nouvel √©l√©ment de message
        const newMessage = document.createElement('div');
        newMessage.classList.add('message');

        // S√©parer le nom d'utilisateur et le message
        const messageParts = data.message.split(":");
        if (messageParts.length >= 2) {
        const username = messageParts[0].trim();
        const messageContent = messageParts.slice(1).join(":").trim();
        const timestamp = data.timestamp || 'Heure non d√©finie';  // R√©cup√©rer le timestamp ou afficher un message par d√©faut

        // Cr√©er une structure avec trois parties : username, timestamp et message content
        if (username === "{{ user.username }}") {
            newMessage.innerHTML = `
                <span class="username">Moi</span> 
                <span class="timestamp">${timestamp} :</span>
                <div class="content">${messageContent}</div>
            `;
        } else {
            newMessage.innerHTML = `
                <span class="other-username">${username}</span> 
                <span class="timestamp">${timestamp} :</span>
                <div class="content">${messageContent}</div>
            `;
        }
            // Ajouter le nouveau message dans le chat log
            chatLog.appendChild(newMessage);

            // Faire d√©filer le chat vers le bas
            chatLog.scrollTop = chatLog.scrollHeight;
        }
    };

    // Envoi du message pour le chat public lors de l'appui sur "Enter" ou le bouton "Envoyer"
    document.querySelector('#chatMessageInput').onkeyup = function(e) {
        if (e.keyCode === 13) {
            document.querySelector('#sendMessageBtn').click();
        }
    };

    document.querySelector('#sendMessageBtn').onclick = function(e) {
        const messageInputDom = document.querySelector('#chatMessageInput');
        const message = messageInputDom.value.trim();

        // Envoyer le message via WebSocket pour le chat public
        if (message) {
            chatSocket.send(JSON.stringify({
                'message': message  // Seul le message est envoy√©, l'utilisateur est inclus c√¥t√© serveur
            }));
            messageInputDom.value = '';  // Vider le champ de message apr√®s envoi
        }
    };

    // Envoi du message pour le chat priv√© (lorsque l'utilisateur clique sur "Envoyer")
    document.querySelector('#sendPrivateMessageBtn').onclick = function(e) {
        const messageInputDom = document.querySelector('#privateChatMessageInput');
        const message = messageInputDom.value.trim();

        if (message && activePrivateChatUser) {
            // Logique d'envoi du message priv√© via WebSocket ou autre m√©thode (exemple √† compl√©ter)
            console.log(`Envoi du message priv√© √† ${activePrivateChatUser}: ${message}`);

            // Afficher le message dans la fen√™tre de chat priv√©e
            const newMessage = document.createElement('div');
            newMessage.classList.add('message');
            newMessage.innerHTML = `<strong>Moi:</strong> ${message}`;
            privateChatMessages.appendChild(newMessage);

            // Vider le champ de message apr√®s envoi
            messageInputDom.value = '';
        }
    };

    // Envoi du message priv√© avec la touche "Enter"
    document.querySelector('#privateChatMessageInput').onkeyup = function(e) {
        if (e.keyCode === 13) {
            document.querySelector('#sendPrivateMessageBtn').click();
        }
    };


    
</script>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const privateChatMessages = document.getElementById('privateChatMessages');
        let activePrivateChatUser = null;  // L'utilisateur avec qui on discute en priv√©

        

        // Ajouter un √©couteur d'√©v√©nement pour chaque utilisateur dans la liste (pour chat priv√©)
        document.querySelectorAll('.user-item').forEach(function(userItem) {
            userItem.addEventListener('click', function() {
                const selectedUsername = this.dataset.username;

                // D√©finir l'utilisateur actuellement s√©lectionn√©
                activePrivateChatUser = selectedUsername;

                // Afficher la bo√Æte de dialogue priv√©e pour cet utilisateur
                privateChatMessages.innerHTML = `<h5>Chat avec ${selectedUsername}</h5>`;
                // Ouvrir une connexion WebSocket pour le chat priv√© avec cet utilisateur
                openPrivateChat(selectedUsername);
            });
        });


        function formatMessageContent(message) {
            return message.replace(/\n/g, '<br>');
        }

        // Fonction pour ouvrir une connexion WebSocket pour le chat priv√©
        function openPrivateChat(username) {
            const privateChatSocket = new WebSocket('ws://' + window.location.host + '/ws/private_chat/' + username + '/');

            // Lorsqu'un nouveau message est re√ßu via WebSocket (pour le chat priv√©)
            privateChatSocket.onmessage = function(e) {
                const data = JSON.parse(e.data);
                const newMessage = document.createElement('div');
                newMessage.classList.add('message');

                const messageParts = data.message.split(":");
                if (messageParts.length >= 2) {
                    const sender = messageParts[0].trim();
                    const messageContent = formatMessageContent(messageParts.slice(1).join(":").trim());  // Utiliser la fonction ici
                    const timestamp = data.timestamp || 'Heure non d√©finie';  // R√©cup√©rer le timestamp

                    // Cr√©er une structure avec trois parties : username, timestamp et message content
                    if (sender === "{{ user.username }}") {
                        newMessage.innerHTML = `
                            <span class="username">Moi</span> 
                            <span class="timestamp">${timestamp} :</span>
                            <div class="content">${messageContent}</div>
                        `;
                    } else {
                        newMessage.innerHTML = `
                            <span class="other-username">${sender}</span> 
                            <span class="timestamp">${timestamp} :</span>
                            <div class="content">${messageContent}</div>
                        `;
                    }

                    privateChatMessages.appendChild(newMessage);
                    privateChatMessages.scrollTop = privateChatMessages.scrollHeight;  // Faire d√©filer vers le bas
                }
            };

            // Envoi du message pour le chat priv√© lors de l'appui sur "Enter" ou le bouton "Envoyer"
            document.querySelector('#privateChatMessageInput').onkeyup = function(e) {
                if (e.keyCode === 13) {
                    document.querySelector('#sendPrivateMessageBtn').click();
                }
            };

            document.querySelector('#sendPrivateMessageBtn').onclick = function(e) {
                const messageInputDom = document.querySelector('#privateChatMessageInput');
                const message = messageInputDom.value.trim();

                if (message && activePrivateChatUser) {
                    // Envoyer le message via WebSocket sans l'afficher manuellement
                    privateChatSocket.send(JSON.stringify({
                        'message': message
                    }));

                    // Vider le champ de message apr√®s envoi
                    messageInputDom.value = '';
                }
            };
        }
    });
</script>

<script>
    document.addEventListener('DOMContentLoaded', function() {
    const publicChatBody = document.getElementById('publicChatBody');
    const privateChatBody = document.getElementById('privateChatBody');
    const publicChatFooter = document.getElementById('publicChatFooter');
    const privateChatFooter = document.getElementById('privateChatFooter');
    const publicChatBtn = document.getElementById('publicChatBtn');
    const privateChatBtn = document.getElementById('privateChatBtn');

    // Fonction pour ajuster la hauteur du chat priv√© en fonction de l'affichage du footer
    function adjustPrivateChatHeight() {
        if (privateChatFooter.style.display === 'block') {
            privateChatBody.style.height = 'calc(100% - 100px)';  // Ajustez la hauteur selon vos besoins
        } else {
            privateChatBody.style.height = '100%';  // Maximiser la hauteur si le footer est masqu√©
        }
    }

    // Affichage du chat public par d√©faut
    publicChatBtn.addEventListener('click', function() {
        publicChatBody.style.display = 'block';
        privateChatBody.style.display = 'none';
        publicChatFooter.style.display = 'block';   // Afficher le footer du chat public
        privateChatFooter.style.display = 'none';   // Masquer le footer du chat priv√©
        privateChatBody.style.height = 'calc(100% - 100px)';  // Ajuster la hauteur si le footer est visible
    });

    // Affichage du chat priv√©
    privateChatBtn.addEventListener('click', function() {
        publicChatBody.style.display = 'none';
        privateChatBody.style.display = 'block';
        publicChatFooter.style.display = 'none';    // Masquer le footer du chat public
        privateChatFooter.style.display = 'block';  // Afficher le footer du chat priv√©
        adjustPrivateChatHeight();  // Ajuster la hauteur du chat priv√©
    });

    // Envoi du message pour le chat public avec gestion de "Shift + Entr√©e" pour retour √† la ligne
    document.querySelector('#chatMessageInput').addEventListener('keydown', function(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();  // Emp√™che le saut de ligne
            document.querySelector('#sendMessageBtn').click();  // Envoie le message
        }
    });

    // Envoi du message priv√© avec gestion de "Shift + Entr√©e" pour retour √† la ligne
    document.querySelector('#privateChatMessageInput').addEventListener('keydown', function(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();  // Emp√™che le saut de ligne
            document.querySelector('#sendPrivateMessageBtn').click();  // Envoie le message
        }
    });


    // S√©lectionnez l'onglet Public par d√©faut au chargement
    publicChatBtn.click();
});

</script>

{% endblock %}


